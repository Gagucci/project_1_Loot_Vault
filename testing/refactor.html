<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Ubuntu:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <title>Loot Vault Refactor</title>
    <style>
        :root {
            --clr-1: #1A1D22;
            --clr-2: #1B273B;
            --clr-3: #535D6E;
            --clr-4: #8D9FBA;
            --clr-5: #FFD262;
            --ff-main-txt: 'Ubuntu', sans-serif;
            --ff-hdr-txt: 'Teko', sans-serif;
        }
        .bg-clr-1 {background: var(--clr-1);}
        .bg-clr-2 {background: var(--clr-2);}
        .bg-clr-3 {background: var(--clr-3);}
        .bg-clr-4 {background: var(--clr-5);}
        .txt-clr-pri {color: var(--clr-4);}
        .txt-clr-sec {color: var(--clr-5);}
        body {font-family: var(--ff-main-txt);}
        nav {font-family: var(--ff-hdr-txt);}
        .navbar-item {color: var(--clr-4);}
        .navbar-menu .navbar-start .navbar-item:hover {background-color: var(--clr-2); color: var(--clr-5);}
        .navbar-brand a:hover {color: var(--clr-5);}
        main {min-height: 100vh;}
        main h2 {font-family: var(--ff-hdr-txt);}
        footer a {color: var(--clr-4);}
        footer a:hover {color: var(--clr-5);}
        footer h3 {font-family: var(--ff-hdr-txt);}
    </style>
</head>
<body class="bg-clr-1 has-text-grey-lighter">
    <header>
        <!-- Bulma's basic navbar implementation with some customization -->
        <nav class="navbar is-transparent bg-clr-2 p-2" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a href="index.html"><img src="../assets/images/FInal Logo.png" width="300px"></a>
                <!-- Hidden until screen size is small -->
                <a role="button" class="navbar-burger txt-clr-pri" data-target="navMenu" aria-label="menu" aria-expanded="false">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>
            <div class="navbar-menu bg-clr-2" id="navMenu">
                <div class="navbar-start mx-auto">
                    <a id="best-deals" class="navbar-item is-size-3 mr-6">Best Deals</a>
                    <a id="highest-rated" class="navbar-item is-size-3 mr-6">Highest Rated</a>
                    <a id="free-games" class="navbar-item is-size-3 mr-6">Free Games</a>
                    <a id="my-wishlist" class="navbar-item is-size-3">My Wishlist</a>
                </div>
                <div class="navbar-end">
                    <div class="navbar-item">
                        <form id="search-bar" class="is-flex is-justify-content-space-between">
                            <input id="search-input" class="input is-normal mr-2" type="text" placeholder="Search For Games" required>
                            <button id="search-button" class="button bg-clr-4" type="submit">Search</button>
                        </form>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <main class="bg-clr-3">
        <!-- DYNAMIC GENERATED CONTENT HERE -->
    </main>
    <footer class="footer bg-clr-2">
        <div class="container is-fluid columns">
            <section class="column">
                <h3 class="is-size-3 has-text-weight-bold">The Meme Team</h3>
                <ul>
                    <li>Avery Myers - <a href="https://github.com/AveryJMyers" target="_blank">AveryJMyers</a></li>
                    <li>Charles Alagos - <a href="https://github.com/Kregkoda" target="_blank">Kregkoda</a></li>
                    <li>Edward Von Schondorf - <a href="https://github.com/Torvec" target="_blank">Torvec</a></li>
                    <li>Jacob Simmons - <a href="https://github.com/Justcallmejayy" target="_blank">Justcallmejayy</a></li>
                    <li>Kevin Gagante - <a href="https://github.com/Gagucci" target="_blank">Gagucci</a></li>
                </ul>
            </section>
            <section class="column">
                <h3 class="is-size-3 has-text-weight-bold">Powered By</h3>
                <ul>
                    <li><a href="https://rawg.io/apidocs" target="_blank">RAWG Video Games Database API</a></li>
                    <li><a href="https://www.gamerpower.com/api-read" target="_blank">Gamerpower Free Games API</a></li>
                    <li><a href="https://apidocs.cheapshark.com/" target="_blank">Cheapshark API</a></li>
                    <li><a href="https://bulma.io/" target="_blank">Bulma CSS Framework</a></li>
                </ul>
            </section>
            <section class="column">
                <h3 class="is-size-3 has-text-weight-bold">About</h3>
                <p>Project 01: Loot Vault</p>
                <p>A UC Berkley Full Stack Web Development Bootcamp Project</p>
                <p>Created June 2023</p>
            </section>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.3/dayjs.min.js" integrity="sha256-iu/zLUB+QgISXBLCW/mcDi/rnf4m4uEDO0wauy76x7U=" crossorigin="anonymous"></script>
    <script>
    
    // Bulma's Navbar Burger Menu implementation from https://bulma.io/documentation/components/navbar/
    document.addEventListener('DOMContentLoaded', () => {
        // Get all "navbar-burger" elements
        const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
        // Add a click event on each of them
        $navbarBurgers.forEach( el => {
            el.addEventListener('click', () => {
                // Get the target from the "data-target" attribute
                const target = el.dataset.target;
                const $target = document.getElementById(target);
                // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
                el.classList.toggle('is-active');
                $target.classList.toggle('is-active');
            });
        });
    });

    // VARIABLES
    
    const rawgAPIKey = "cb7fd697d0f04be5879ce9e0eb0c1473";
    const searchBtn = document.getElementById("search-button");
    const bestDealBtn = document.getElementById("best-deals");
    const highestRatedBtn = document.getElementById("highest-rated");
    const freeGamesBtn = document.getElementById("free-games");
    const myWishlistBtn = document.getElementById("my-wishlist");

   
    
    let ratedStartDate = dayjs().format("YYYY-MM-DD");
    let ratedEndDate = dayjs().subtract(1, "year").format("YYYY-MM-DD");
        
    const main = document.querySelector("main");

    // FUNCTION DECLARATIONS

    function createPageTitle(text) {
        let hero = document.createElement("section");
        hero.setAttribute("class", "hero is-medium bg-clr-1");
        main.appendChild(hero);
        let heroBody = document.createElement("div");
        heroBody.setAttribute("class", "hero-body");
        hero.appendChild(heroBody);
        let heroBodyText = document.createElement("h1");
        heroBodyText.setAttribute("class", "is-size-1 has-text-centered has-text-weight-bold");
        heroBodyText.textContent = text;
        heroBody.appendChild(heroBodyText);
    }
    
    // Uses the RAWG API to search for a game and it displays relevant results on the page
    function searchGames() {
        createPageTitle("Search Results");
        var search = document.getElementById("search-input").value;
        let slug = search.split(" ").join("-").toLowerCase();
        const gamesUrl = `https://api.rawg.io/api/games?key=${rawgAPIKey}&search=${slug}&platforms=18,1,7`;
        fetch(gamesUrl)
            .then((response) => response.json())
            .then((data) => {            
            if (data.results.length === 0) {
                const gameName = document.createElement("p");
                gameName.textContent = "No results found";
                main.appendChild(gameName);
            }
            data.results.forEach((game) => {
                let screenshots = "";
                if (game.short_screenshots.length > 0) {
                    screenshots = game.short_screenshots[0].image;
                }
                const gameContainer = document.createElement("div");
                gameContainer.setAttribute("class", "gameContainer");
                gameContainer.innerHTML = 
                `<div class="container is-fluid p-5 bd">
                    <h2 class="is-size-3 has-text-weight-bold">${game.name}</h3>
                    <p>Rating: ${game.rating}</p>
                    <p>Release Date: ${game.released}</p>
                    <img src="${screenshots}" alt="${game.name} cover">
                </div>`;
                main.appendChild(gameContainer);
            });
            })
            .catch((error) => {
                console.error("Error:", error);
        });
    };

    // Uses the Cheapshark API to fetch the best deals and display them on the page
    function fetchBestDeals() {
        createPageTitle("Best Deals");
        const cheapsharkURL = `https://www.cheapshark.com/api/1.0/deals?storeID=1&onSale=1&pageSize=10`;
        fetch(cheapsharkURL)
            .then((response) => response.json())
            .then((data) => {

                const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];

                data.slice(0, 10).forEach((game) => {
                    const gameName = game.title;
                    const normalPrice = game.normalPrice;
                    const salePrice = game.salePrice;
                    const dealRating = game.dealRating;
                    const metacriticScore = game.metacriticScore;
                    const id = game.dealID;

                    const gameContainer = document.createElement("div");
                    gameContainer.setAttribute("class", "gameContainer");
                    gameContainer.innerHTML = 
                    `<div class="container is-widescreen p-5">
                        <h2 class="is-size-3 has-text-weight-bold">${gameName}</h2>
                        <p>Metacritic Score: ${metacriticScore}</p>
                        <p>Normal Price: $${normalPrice}</p>
                        <p>Sale Price: $${salePrice}</p>
                        <p>Deal Rating: ${dealRating}</p>
                        <a href="https://www.cheapshark.com/redirect?dealID=${id}" target="_blank" class="is-size-3">Buy Now</a>
                        <button class="wishlist-button">Add to Wishlist</button>
                    </div>`;
                    main.appendChild(gameContainer);

                    const wishlistButton = gameContainer.querySelector('.wishlist-button');
                    // Check if the game is already in the wishlist
                    if (wishlist.includes(gameName)) {
                        wishlistButton.textContent = 'Item Added!';
                        wishlistButton.disabled = true;
                    }
                    wishlistButton.addEventListener('click', () => {
                        addToWishlist(gameName, wishlistButton);
                    });
                });
            })
        .catch((error) => {
            console.error("Error:", error);
        });
    };

    // Uses the RAWG API to fetch the highest rated games and display them on the page
    function fetchHighestRated() {
        createPageTitle("Highest Rated");
        var rawgURL = `https://api.rawg.io/api/games?key=${rawgAPIKey}&metacritic&platforms=18,1,7&ordering=-metacritic`;
        fetch(rawgURL)
            .then((response) => response.json())
            .then((data) => {
            var games = data.results.slice(0, 10);
            games.forEach((game) => {
                const gameName = game.name;
                const metacritic = game.metacritic;
                let playtime = game.playtime;
                let platforms = game.platforms.map((platform) => platform.platform.name).join(", ");
                if (playtime === 0) {
                    playtime = "N/A";
                }
                const gameContainer = document.createElement("div");
                gameContainer.setAttribute("class", "gameContainer");
                gameContainer.innerHTML = 
                `<div class="container is-widescreen p-5">  
                    <h2 class="is-size-2 has-text-weight-bold">${gameName}</h2>
                    <p>Metacritic Score: ${metacritic}</p>
                    <p>Playtime: ${playtime} hours</p>
                    <p> Platforms: ${platforms}
                </div>`;
                main.appendChild(gameContainer);
            });
            })
        .catch((error) => {
            console.error("Error:", error);
        });
    }

    // Uses the Gamerpower API to fetch free games and display them on the page
    function fetchFreeGames() {
        createPageTitle("Free Games");
        // Original code taken from https://rapidapi.com/digiwalls/api/gamerpower and modified to work with the fetch method
        const url = "https://gamerpower.p.rapidapi.com/api/giveaways";
        const options = {
            method: "GET",
            headers: {
                "X-RapidAPI-Key": "b376f2e9e7msh1e177bc5d80ec31p1c15f4jsn146ea5790a77",
                "X-RapidAPI-Host": "gamerpower.p.rapidapi.com",
            }
        };
        fetch(url, options)
        .then(function (response) {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
            })
            .then(function (result) {
                const container = document.createElement("div");
                container.setAttribute("class", "container is-widescreen p-5");
                const gameContainer = document.createElement("div");
                gameContainer.setAttribute("class", "columns is-multiline");
                for (let i = 0; i < result.length; i++) {
                    var gameTitle = result[i].title;
                    var gameDescription = result[i].description;
                    var endDate = result[i].end_date;
                    var formatEndDate = dayjs(endDate).format("MMMM D, YYYY");
                    if (formatEndDate === "Invalid Date") {
                        formatEndDate = "N/A";
                    }
                    var status = result[i].status;
                    var platforms = result[i].platforms;
                    var worth = result[i].worth;
                    gameContainer.innerHTML += 
                    `
                    <div class="column is-one-quarter">
                        <div class="card has-background-grey-lighter">
                            <header class="card-header">
                                <p class="card-header-title">${gameTitle}</p>
                            </header>
                            <div class="card-content">
                                <div class="content">
                                    <p class="subtitle">Platforms: ${platforms}</p>
                                    <p>Worth: ${worth}</p>
                                </div>
                            </div>
                            <footer class="card-footer">
                                <p class="card-footer-item">End Date:<br>${formatEndDate}</p>
                                <p class="card-footer-item">Status:<br>${status}</p>
                            </footer>
                        </div>
                    </div>
                    `;
                }
                container.appendChild(gameContainer);
                main.appendChild(container);
            })
        .catch(function (error){
            console.error(error)
        });
    };

    // Display's the user's wishlist that is saved in local storage
    function myWishlist() {
        createPageTitle("My Wishlist");
        var wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        if (wishlist.length === 0) {
            const gameContainer = document.createElement("div");
            gameContainer.setAttribute("class", "gameContainer");
            gameContainer.innerHTML = 
            `<div class="container is-widescreen p-5">
                <h2 class="is-size-3 has-text-weight-bold">Your wishlist is empty</h2>
                <p>Search for games and add them to your wishlist</p>
            </div>`;
            main.appendChild(gameContainer);
        } else {
            const gameContainer = document.createElement("div");
            gameContainer.setAttribute("class", "gameContainer");
            for (let i = 0; i < wishlist.length; i++) {
                gameContainer.innerHTML += 
                `<div class="container is-widescreen p-5">
                    <h2 class="is-size-3 has-text-weight-bold">${wishlist[i]}</h2>
                    <button class="button is-danger is-light" id="removeBtn">Remove</button>
                </div>`;
                main.appendChild(gameContainer);
            }
        }
    };

    function addToWishlist(gameName, wishlistButton) {
        const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];// Retrieve existing wishlist from local storage
        if (wishlist.includes(gameName)) {// If the gameName is already in the wishlist, then return
            wishlistButton.textContent = "Game Added!";
            wishlistButton.disabled = true;
            return;
        }
        wishlist.push(gameName);// Add the gameName to the wishlist
        localStorage.setItem('wishlist', JSON.stringify(wishlist));// Update the wishlist in local storage
        wishlistButton.textContent = "Item Added";
        wishlistButton.disabled = true;
    }

    // EVENT LISTENERS

    // Is used to search for games when the search button is clicked
    searchBtn.addEventListener('click', function(event) {
        event.preventDefault()
        main.innerHTML = "";
        searchGames(event)
    });

    // Is used to populate the page with the best deals when the best deals button is clicked
    bestDealBtn.addEventListener("click", function (event) {
        event.preventDefault();
        main.innerHTML = "";
        fetchBestDeals(event);
    });

    // Is used to populate the page with the highest rated games when the highest rated button is clicked
    highestRatedBtn.addEventListener("click", function (event) {
        event.preventDefault();
        main.innerHTML = "";
        fetchHighestRated(event);
    });

    // Is used to populate the page with a list of free games when the free games button is clicked
    freeGamesBtn.addEventListener("click", function (event) {
        event.preventDefault();
        main.innerHTML = "";
        fetchFreeGames(event);
    });

    // Is used to display the user's wishlist when the wishlist button is clicked
    myWishlistBtn.addEventListener("click", function (event) {
        event.preventDefault();
        main.innerHTML = "";
        myWishlist(event);
    });

    // Will be used to remove a game from the user's wishlist when the remove from wishlist button is clicked
    // removeFromWishlistBtn.addEventListener("click", function (event) {
    //     event.preventDefault();
    // });

    // Will be used to clear the wishlist when the clear wishlist button is clicked
    // clearWishlistBtn.addEventListener("click", function (event) {
    //     event.preventDefault();
    // });


    // FUNCTION CALLS


    fetchBestDeals(); // ENSURES THAT THE BEST DEALS ARE DISPLAYED ON THE PAGE WHEN THE LOOT VAULT SITE FIRST LOADS

    </script>
</body>
</html>